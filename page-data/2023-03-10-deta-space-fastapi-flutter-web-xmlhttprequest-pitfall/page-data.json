{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2023-03-10-deta-space-fastapi-flutter-web-xmlhttprequest-pitfall/","result":{"data":{"site":{"siteMetadata":{"title":"Beveloper","heroImage":"/images/beveloper-hero.jpg"}},"markdownRemark":{"id":"fb9fcec2-2353-5d5e-aacb-aec2937a2f4c","excerpt":"It's worth to mention, testing API on Postman, no error at all. Checking in DevTool on Chrome, found: This hint rules out many possibilities suggested byâ€¦","html":"<p>It's worth to mention, testing API on Postman, no error at all.</p>\n<p>Checking in DevTool on Chrome, found:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Access to XMLHttpRequest at 'https://xxxxxx.deta.app/users/signIn' from origin 'http://localhost:65301' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: Redirect is not allowed for a preflight request.</code></pre></div>\n<p>This hint rules out many possibilities suggested by results on Google:</p>\n<ol>\n<li>Add CORS rules on FastAPI side. (already done since the beginning of development)</li>\n<li>Add <code class=\"language-text\">Accept: */*</code> to the Header of request. (http package of Flutter already done this by default)</li>\n<li>Add <code class=\"language-text\">&lt;meta name=\"referrer\" content=\"no-referrer\"></code> to html file. (tried, does not work)</li>\n<li>Change <code class=\"language-text\">Uri.parse(uri)</code> to <code class=\"language-text\">Uri.https(url, '/my/apipath')</code>. (No, obviously, the problem is not protocol related)</li>\n</ol>\n<p>According to <a href=\"https://developer.chrome.com/blog/referrer-policy-new-chrome-default/\">Chrome's official blog</a>,</p>\n<blockquote>\n<p>Chrome plans to switch its default policy from no-referrer-when-downgrade to strict-origin-when-cross-origin, starting in version 85.</p>\n</blockquote>\n<h3><strong>OMG, Chrome did this by default due to critical safety issue!</strong></h3>\n<p>Intuition tells me, solutions like this is not clever:</p>\n<ol>\n<li>\n<p>Manipulate Flutter SDK: <a href=\"https://nagomi-informal.net/archives/572\">REF</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1- Go to flutter\\bin\\cache and remove a file named: flutter_tools.stamp\n\n2- Go to flutter\\packages\\flutter_tools\\lib\\src\\web and open the file chrome.dart.\n\n3- Find '--disable-extensions'\n\n4- Add '--disable-web-security'</code></pre></div>\n</li>\n<li>\n<p>Debug Flutter with a specific flag:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">flutter run <span class=\"token parameter variable\">-d</span> chrome --web-browser-flag <span class=\"token string\">\"--disable-web-security\"</span></code></pre></div>\n<p>(how to make sure no problem after <code class=\"language-text\">flutter build web</code>?)</p>\n</li>\n</ol>\n<h1>Focus on the problem</h1>\n<p><code class=\"language-text\">Redirect is not allowed for a preflight request.</code></p>\n<p>Redirect?</p>\n<p>Would FastAPI auto redirect routes from without trailling slash (<code class=\"language-text\">/signIn</code>) to with one (<code class=\"language-text\">/signIn/</code>)?</p>\n<p>Yes, it does.</p>\n<p>Or I given a wrong API endpoint to Flutter?</p>\n<p>No, I double checked, the endpoint is correct.</p>\n<p>Dive into DevTool of Chrome, found a wired redirection:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://deta.space/api/v0/auth/pass?redirect_uri=https%3A%2F%2Fxxxxx.deta.app%2Fusers%2FsignIn</code></pre></div>\n<p>Oh, got it!</p>\n<p>While migrating to deta.space, follow doc's advice, I do not allow public visit to any endpoint, instead, a request with <code class=\"language-text\">X-Space-App-Key</code> is allowed.</p>\n<p>So the request to <code class=\"language-text\">https://xxxxxx.deta.app/users/signIn</code> was redirected, to let Deta verify the token first.</p>\n<p>I guess Postman does not have \"strict-origin-when-cross-origin\" setting, so it does not complain.</p>\n<h1>Solution</h1>\n<p>In Deta's <code class=\"language-text\">Spacefile</code>: <a href=\"https://deta.space/migration/guides/migrate-a-micro\">REF</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">public_routes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"/*\"</span></code></pre></div>\n<p>This allows all routes could be visited publicly.</p>\n<h1>Pain in the neck</h1>\n<p>I really want to make all routes as private, no public access.</p>","frontmatter":{"title":"Deta Space + FastAPI + Flutter Web: XMLHttpRequest Pitfall","date":"2023-03-10T00:00:00+00:00","description":"Migrated a Micro developed with FastAPI from deta.sh to deta.space, Flutter Web yieled an unknown XMLHttpRequest error.","featuredImageUrl":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQs7zPKOy23OSdUw51LPQje1NoDtS_KQiktLg&usqp=CAU"}},"previous":{"fields":{"slug":"/2023-03-10-deta-space-fastapi-orjson-error/"},"frontmatter":{"title":"Deta Space + FastAPI: module 'orjson' has no attribute 'JSONEncoder'"}},"next":{"fields":{"slug":"/2023-02-28-practical-shell-script-snippets/"},"frontmatter":{"title":"Practical Shell Script Snippets"}}},"pageContext":{"id":"fb9fcec2-2353-5d5e-aacb-aec2937a2f4c","previousPostId":"78efdf25-b907-59c0-9229-925801ff0969","nextPostId":"c136a23a-ab19-5a10-a7d5-d39fc30c9415"}},"staticQueryHashes":["1261413882","2660733687"]}