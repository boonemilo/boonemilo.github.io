{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2023-03-10-deta-space-fastapi-orjson-error/","result":{"data":{"site":{"siteMetadata":{"title":"Beveloper","heroImage":"/images/beveloper-hero.jpg"}},"markdownRemark":{"id":"78efdf25-b907-59c0-9229-925801ff0969","excerpt":"Situation The FastAPI project is very basic, just a 'hello world' one: As FastAPI official doc suggests, install dependencies, then add to requirements.txtâ€¦","html":"<h1>Situation</h1>\n<p>The FastAPI project is very basic, just a 'hello world' one:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># main.py</span>\n<span class=\"token triple-quoted-string string\">\"\"\"App Entry\"\"\"</span>\n<span class=\"token keyword\">from</span> fastapi <span class=\"token keyword\">import</span> Depends<span class=\"token punctuation\">,</span> FastAPI\n<span class=\"token keyword\">from</span> fastapi<span class=\"token punctuation\">.</span>middleware<span class=\"token punctuation\">.</span>cors <span class=\"token keyword\">import</span> CORSMiddleware\n\napp <span class=\"token operator\">=</span> FastAPI<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\norigins <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"*\"</span>\n<span class=\"token punctuation\">]</span>\n\napp<span class=\"token punctuation\">.</span>add_middleware<span class=\"token punctuation\">(</span>\n    CORSMiddleware<span class=\"token punctuation\">,</span>\n    allow_origins<span class=\"token operator\">=</span>origins<span class=\"token punctuation\">,</span>\n    allow_credentials<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    allow_methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"*\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    allow_headers<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"*\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"This is doc string.\"\"\"</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hello world! Here comes Demo!\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>As FastAPI official doc suggests, install dependencies, then add to requirements.txt</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pip <span class=\"token function\">install</span> <span class=\"token string\">\"fastapi[all]\"</span>\npip freeze <span class=\"token operator\">></span> requirements.txt</code></pre></div>\n<p>After <code class=\"language-text\">space push</code>, it yields:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error Type:\nAttributeError\n\nError Message:\nmodule 'orjson' has no attribute 'JSONEncoder'\n...\nTraceback (most recent call last):\n  File \"/var/lang/lib/python3.9/importlib/__init__.py\", line 127, in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\n  File \"\", line 1030, in _gcd_import\n  File \"\", line 1007, in _find_and_load\n  File \"\", line 986, in _find_and_load_unlocked\n  File \"\", line 680, in _load_unlocked\n  File \"\", line 850, in exec_module\n  File \"\", line 228, in _call_with_frames_removed\n  File \"/var/task/_entry.py\", line 2, in\n    from detalib.handler import handle\n  File \"/opt/python/detalib/handler.py\", line 3, in\n    from . import handlers\n  File \"/opt/python/detalib/handlers.py\", line 1, in\n    from .event import parse_event\n  File \"/opt/python/detalib/event.py\", line 1, in\n    from .helpers import json\n  File \"/opt/python/detalib/helpers.py\", line 16, in\n    class CustomJSONEncoder(json.JSONEncoder):\n...\n</code></pre></div>\n<h1>Solution</h1>\n<p>If comment out <code class=\"language-text\"># orjson==3.8.7</code> in requirements.txt, then <code class=\"language-text\">space push</code>, error dismissed.</p>\n<h1>Pain in the neck</h1>\n<p>To enable Deta to host a 'hello world' FastAPI micro, <code class=\"language-text\">pip install fastapi</code> is enough. Only these packages are installed:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">anyio==3.6.2\nfastapi==0.93.0\nidna==3.4\npydantic==1.10.6\nsniffio==1.3.0\nstarlette==0.25.0\ntyping_extensions==4.5.0</code></pre></div>\n<p>If then <code class=\"language-text\">pip install \"uvicorn[standard]\"</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">anyio==3.6.2\nclick==8.1.3\nfastapi==0.93.0\nh11==0.14.0\nhttptools==0.5.0\nidna==3.4\npydantic==1.10.6\npython-dotenv==1.0.0\nPyYAML==6.0\nsniffio==1.3.0\nstarlette==0.25.0\ntyping_extensions==4.5.0\nuvicorn==0.21.0\nuvloop==0.17.0\nwatchfiles==0.18.1\nwebsockets==10.4</code></pre></div>\n<p>But, <code class=\"language-text\">pip install \"fastapi[all]\"</code> would involve far more dependencies, including <code class=\"language-text\">orjson==3.8.7</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">anyio==3.6.2\ncertifi==2022.12.7\nclick==8.1.3\ndnspython==2.3.0\nemail-validator==1.3.1\nfastapi==0.93.0\nh11==0.14.0\nhttpcore==0.16.3\nhttptools==0.5.0\nhttpx==0.23.3\nidna==3.4\nitsdangerous==2.1.2\nJinja2==3.1.2\nMarkupSafe==2.1.2\norjson==3.8.7\npydantic==1.10.6\npython-dotenv==1.0.0\npython-multipart==0.0.6\nPyYAML==6.0\nrfc3986==1.5.0\nsniffio==1.3.0\nstarlette==0.25.0\ntyping_extensions==4.5.0\nujson==5.7.0\nuvicorn==0.21.0\nuvloop==0.17.0\nwatchfiles==0.18.1\nwebsockets==10.4</code></pre></div>\n<p>As <a href=\"https://fastapi.tiangolo.com/advanced/custom-response/?h=#use-orjsonresponse\">FastAPI doc mentioned</a>:</p>\n<blockquote>\n<p>For example, if you are squeezing performance, you can install and use orjson and set the response to be ORJSONResponse.</p>\n</blockquote>\n<p>So, maybe this is a problem of Deta?</p>","frontmatter":{"title":"Deta Space + FastAPI: module 'orjson' has no attribute 'JSONEncoder'","date":"2023-03-10T01:00:00+00:00","description":"A brand new FastAPI project pushed to deta.space, yields: module 'orjson' has no attribute 'JSONEncoder'.","featuredImageUrl":"https://pythonfix.com/pkg/o/orjson/orjson-banner.webp"}},"previous":null,"next":{"fields":{"slug":"/2023-03-10-deta-space-fastapi-flutter-web-xmlhttprequest-pitfall/"},"frontmatter":{"title":"Deta Space + FastAPI + Flutter Web: XMLHttpRequest Pitfall"}}},"pageContext":{"id":"78efdf25-b907-59c0-9229-925801ff0969","previousPostId":null,"nextPostId":"fb9fcec2-2353-5d5e-aacb-aec2937a2f4c"}},"staticQueryHashes":["1261413882","2660733687"]}